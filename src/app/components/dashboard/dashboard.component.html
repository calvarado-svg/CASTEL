<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <h1>Dashboard - Simulación CASTEL</h1>
    <p class="subtitle">Sistema de Gestión de Agentes de Trading</p>
  </header>

  <!-- Gráfico de Evolución del Ranking -->
  <div *ngIf="!cargando && !error">
    <app-ranking-evolution-chart
      [hipotesis]="hipotesisActual">
    </app-ranking-evolution-chart>
  </div>

  <!-- Loading State -->
  <div *ngIf="cargando" class="loading">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !cargando" class="error-message">
    <p>{{ error }}</p>
    <button (click)="cargarDatos()" class="btn-retry">Reintentar</button>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!cargando && !error" class="dashboard-content">

    <!-- Card Actions -->
    <div class="card-actions">
      <button routerLink="/nueva-simulacion" class="btn-primary">
        Nueva Simulación
      </button>
      <button routerLink="/timeline" class="btn-secondary">
        Timeline de Eventos
      </button>
      <button routerLink="/timeline-calendario" class="btn-secondary">
        Timeline Calendario
      </button>
    </div>

    <!-- Resumen Global -->
    <div class="stats-grid" *ngIf="resumenCuentas">
      <div class="stat-card">
        <div class="stat-icon">$</div>
        <div class="stat-content">
          <h3>Balance Total</h3>
          <p class="stat-value">
            {{ formatearMoneda(resumenCuentas.resumen.balanceActualTotal) }}
          </p>
          <p class="stat-subtitle">
            de {{ formatearMoneda(resumenCuentas.resumen.balanceInicialTotal) }} inicial
          </p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">%</div>
        <div class="stat-content">
          <h3>ROI Promedio Global</h3>
          <p
            class="stat-value"
            [ngClass]="obtenerClaseROI(resumenCuentas.resumen.roiPromedioGlobal)"
          >
            {{ formatearPorcentaje(resumenCuentas.resumen.roiPromedioGlobal) }}
          </p>
          <p class="stat-subtitle">
            {{ formatearMoneda(resumenCuentas.resumen.gananciaTotal) }} ganancia
          </p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">#</div>
        <div class="stat-content">
          <h3>Total Cuentas</h3>
          <p class="stat-value">
            {{ resumenCuentas.resumen.totalCuentas }}
          </p>
          <p class="stat-subtitle">
            {{ resumenCuentas.resumen.distribucionPorAgente.length }} agentes activos
          </p>
        </div>
      </div>

      <div class="stat-card" *ngIf="ultimaSimulacion">
        <div class="stat-icon">i</div>
        <div class="stat-content">
          <h3>Última Simulación</h3>
          <p class="stat-value estado" [ngClass]="'estado-' + ultimaSimulacion.estado.toLowerCase()">
            {{ ultimaSimulacion.estado }}
          </p>
          <p class="stat-subtitle">
            {{ formatearFecha(ultimaSimulacion.fechaCreacion) }}
          </p>
        </div>
      </div>
    </div>

    <!-- TOP 10 Ranking -->
    <div class="section">
      <h2>TOP 10 - Ranking de Agentes</h2>

      <div *ngIf="top10Cargando" class="loading">
        <div class="spinner"></div>
        <p>Calculando TOP10... Esto puede tardar varios minutos</p>
      </div>

      <div *ngIf="top10Error && !top10Cargando" class="error-message">
        <p>{{ top10Error }}</p>
        <button (click)="cargarDatos()" class="btn-retry">Reintentar</button>
      </div>

      <div *ngIf="!top10Cargando && !top10Error && top10.length === 0" class="empty-state">
        <p>No hay agentes en el ranking para esta hipótesis.</p>
        <button routerLink="/nueva-simulacion" class="btn-primary">
          Ejecutar Primera Simulación
        </button>
      </div>

      <table *ngIf="!top10Cargando && top10.length > 0" class="table-ranking">
        <thead>
          <tr>
            <th>Pos</th>
            <th>Usuario</th>
            <th>Symbol</th>
            <th>ROI Último Periodo</th>
            <th>ROI Promedio</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <!-- TOP 10 Agentes (Activos) -->
          <tr
            *ngFor="let agente of top10"
            [class.top-3]="agente.posicion <= 3"
            [routerLink]="['/agente', agente.agente_id]"
            class="clickable-row"
          >
            <td class="posicion">
              <span class="badge-posicion" [class.top-3]="agente.posicion <= 3">
                {{ agente.posicion }}
              </span>
            </td>
            <td class="usuario">{{ agente.userId }}</td>
            <td class="symbol">{{ agente.symbol }}</td>
            <td [ngClass]="obtenerClaseROI(agente.roiHipotesis)">
              {{ formatearPorcentaje(agente.roiHipotesis) }}
            </td>
            <td [ngClass]="obtenerClaseROI(agente.roiPromedio)">
              {{ formatearPorcentaje(agente.roiPromedio) }}
            </td>
            <td>
              <span class="badge" [class]="'badge-' + agente.estadoAgente.toLowerCase()">
                {{ agente.estadoAgente }}
              </span>
            </td>
          </tr>

          <!-- Siguientes 10 Agentes (Posiciones 11-20, en espera) -->
          <tr
            *ngFor="let agente of siguientes10"
            [routerLink]="['/agente', agente.agente_id]"
            class="clickable-row en-espera"
          >
            <td class="posicion">
              <span class="badge-posicion">
                {{ agente.posicion }}
              </span>
            </td>
            <td class="usuario">{{ agente.userId }}</td>
            <td class="symbol">{{ agente.symbol }}</td>
            <td [ngClass]="obtenerClaseROI(agente.roiHipotesis)">
              {{ formatearPorcentaje(agente.roiHipotesis) }}
            </td>
            <td [ngClass]="obtenerClaseROI(agente.roiPromedio)">
              {{ formatearPorcentaje(agente.roiPromedio) }}
            </td>
            <td>
              <span class="badge" [class]="'badge-' + agente.estadoAgente.toLowerCase()">
                {{ agente.estadoAgente }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Estadísticas del TOP 10 -->
      <div *ngIf="!top10Cargando && top10.length > 0" class="top10-stats-container">
        <!-- Cards de Estadísticas -->
        <div class="top10-stats-grid">
          <div class="top10-stat-card mejor">
            <div class="stat-header">
              <h3>Mejor ROI</h3>
            </div>
            <div class="stat-body" *ngIf="mejorAgente">
              <p class="stat-value positivo">{{ formatearPorcentaje(mejorAgente.roiHipotesis) }}</p>
              <p class="stat-label">{{ mejorAgente.userId }}</p>
              <p class="stat-sublabel">{{ mejorAgente.symbol }}</p>
            </div>
          </div>

          <div class="top10-stat-card promedio">
            <div class="stat-header">
              <h3>ROI Promedio</h3>
            </div>
            <div class="stat-body">
              <p class="stat-value" [ngClass]="obtenerClaseROI(roiPromedio)">
                {{ formatearPorcentaje(roiPromedio) }}
              </p>
              <p class="stat-label">TOP 10 Agentes</p>
            </div>
          </div>

          <div class="top10-stat-card peor">
            <div class="stat-header">
              <h3>Peor ROI (TOP10)</h3>
            </div>
            <div class="stat-body" *ngIf="peorAgente">
              <p class="stat-value" [ngClass]="obtenerClaseROI(peorAgente.roiHipotesis)">
                {{ formatearPorcentaje(peorAgente.roiHipotesis) }}
              </p>
              <p class="stat-label">{{ peorAgente.userId }}</p>
              <p class="stat-sublabel">{{ peorAgente.symbol }}</p>
            </div>
          </div>
        </div>

        <!-- Gráfico de Barras Horizontales -->
        <div class="top10-chart">
          <h3>Visualización TOP 10 - ROI por Agente</h3>
          <div class="chart-container">
            <div *ngFor="let agente of top10" class="chart-bar-row">
              <div class="bar-label">
                <span class="bar-position">{{ agente.posicion }}</span>
                <span class="bar-userId">{{ agente.userId }}</span>
                <span class="bar-symbol">{{ agente.symbol }}</span>
              </div>
              <div class="bar-wrapper">
                <div
                  class="bar"
                  [class.top-3]="agente.posicion <= 3"
                  [ngClass]="obtenerClaseROI(agente.roiHipotesis)"
                  [style.width.%]="obtenerPorcentajeBarra(agente.roiHipotesis)"
                >
                  <span class="bar-value">{{ formatearPorcentaje(agente.roiHipotesis) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Distribución de ROI -->
    <div class="section">
      <app-distribucion-roi-chart [hipotesis]="hipotesisActual"></app-distribucion-roi-chart>
    </div>

    <!-- Distribución por Agente -->
    <div class="section" *ngIf="resumenCuentas && resumenCuentas.resumen.distribucionPorAgente.length > 0">
      <div class="section-header">
        <h2>Distribución de Cuentas por Agente</h2>

        <!-- Filtros de Ordenamiento -->
        <div class="filter-buttons">
          <button
            [class.active]="ordenDistribucion === 'ranking'"
            (click)="cambiarOrden('ranking')"
            class="filter-btn"
          >
            Por Ranking TOP10
          </button>
          <button
            [class.active]="ordenDistribucion === 'cuentas'"
            (click)="cambiarOrden('cuentas')"
            class="filter-btn"
          >
            Por Cuentas
          </button>
          <button
            [class.active]="ordenDistribucion === 'roi'"
            (click)="cambiarOrden('roi')"
            class="filter-btn"
          >
            Por ROI
          </button>
          <button
            [class.active]="ordenDistribucion === 'balance'"
            (click)="cambiarOrden('balance')"
            class="filter-btn"
          >
            Por Balance
          </button>
        </div>
      </div>

      <!-- Tabla de Distribución -->
      <div class="distribucion-table-container">
        <table class="distribucion-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Agente</th>
              <th>Symbol</th>
              <th>Cuentas</th>
              <th>% Cuentas</th>
              <th>Balance Total</th>
              <th>% Balance</th>
              <th>ROI Promedio</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let dist of distribucionOrdenada; let i = index">
              <!-- Fila principal del agente -->
              <tr
                class="agente-row"
                [class.selected]="agenteSeleccionado === dist.agente_id"
                (click)="seleccionarAgente(dist.agente_id)"
              >
                <td>{{ obtenerPosicionEnRanking(dist.agente_id) }}</td>
                <td class="agente-name">
                  <strong>{{ dist.userId }}</strong>
                </td>
                <td class="symbol">{{ dist.symbol }}</td>
                <td class="cuentas">
                  <span class="badge-count">{{ dist.cuentasAsignadas }}</span>
                </td>
                <td class="percentage">
                  {{ calcularPorcentajeCuentas(dist.cuentasAsignadas).toFixed(1) }}%
                </td>
                <td class="balance">{{ formatearMoneda(dist.balanceTotalCuentas) }}</td>
                <td class="percentage">
                  {{ calcularPorcentajeBalance(dist.balanceTotalCuentas).toFixed(1) }}%
                </td>
                <td [ngClass]="obtenerClaseROI(dist.roiPromedioAgente)">
                  {{ formatearPorcentaje(dist.roiPromedioAgente) }}
                </td>
                <td>
                  <button
                    class="btn-expand"
                    [class.expanded]="agenteSeleccionado === dist.agente_id"
                  >
                    {{ agenteSeleccionado === dist.agente_id ? '▼' : '▶' }}
                  </button>
                </td>
              </tr>

              <!-- Fila expandida con detalles de cuentas -->
              <tr *ngIf="agenteSeleccionado === dist.agente_id" class="expanded-row">
                <td colspan="9">
                  <div class="expanded-content">
                    <h4>Cuentas asignadas a {{ dist.userId }}</h4>
                    <p class="info-text">
                      Este agente tiene en total {{ dist.cuentasAsignadas }} cuenta(s) con un balance total de
                      {{ formatearMoneda(dist.balanceTotalCuentas) }}
                    </p>

                    <!-- Estado de carga -->
                    <div *ngIf="estaCargandoCuentas(dist.agente_id)" class="loading-cuentas">
                      <div class="spinner"></div>
                      <p>Cargando cuentas del agente...</p>
                    </div>

                    <!-- Error al cargar -->
                    <div *ngIf="obtenerErrorCuentas(dist.agente_id)" class="error-cuentas">
                      <p>{{ obtenerErrorCuentas(dist.agente_id) }}</p>
                      <button class="btn-retry" (click)="cargarCuentasDeAgente(dist.agente_id)">
                        Reintentar
                      </button>
                    </div>

                    <!-- Listado de cuentas -->
                    <div *ngIf="!estaCargandoCuentas(dist.agente_id) && !obtenerErrorCuentas(dist.agente_id) && obtenerCuentasAgente(dist.agente_id)" class="cuentas-list">
                      <table class="cuentas-table">
                        <thead>
                          <tr>
                            <th>ID Cuenta</th>
                            <th>Balance Inicial</th>
                            <th>Balance al Casarse</th>
                            <th>Balance Actual</th>
                            <th>ROI Acumulado (Cuenta)</th>
                            <th>ROI con este Agente</th>
                            <th>Divorcios</th>
                            <th>Fecha Matrimonio</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let cuenta of obtenerCuentasAgente(dist.agente_id)?.cuentas">
                            <td class="cuenta-id">{{ cuenta.cuenta_id }}</td>
                            <td>{{ formatearMoneda(cuenta.balanceInicial) }}</td>
                            <td class="balance-matrimonio">
                              {{ formatearMoneda(cuenta.balanceAlCasarse) }}
                            </td>
                            <td>{{ formatearMoneda(cuenta.balanceActual) }}</td>
                            <td [class]="obtenerClaseROI(cuenta.roiAcumulado)">
                              {{ formatearPorcentaje(cuenta.roiAcumulado) }}
                            </td>
                            <td [class]="obtenerClaseROI(cuenta.roiConEsteAgente)">
                              {{ formatearPorcentaje(cuenta.roiConEsteAgente) }}
                            </td>
                            <td class="divorcios">
                              <span class="badge-divorcios" *ngIf="cuenta.numMatrimoniosAnteriores > 0">
                                {{ cuenta.numMatrimoniosAnteriores }}
                              </span>
                              <span *ngIf="cuenta.numMatrimoniosAnteriores === 0" class="sin-divorcios">-</span>
                            </td>
                            <td>{{ formatearFecha(cuenta.fechaMatrimonio) }}</td>
                            <td>
                              <button class="btn-detalle" (click)="verDetalleCuenta($event, cuenta.cuenta_id)">
                                Ver Detalle
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>

      <!-- Gráficos de Visualización -->
      <div class="charts-grid">
        <!-- Gráfico de Distribución de Cuentas -->
        <div class="chart-card">
          <h3>Top 5 Agentes por Cantidad de Cuentas</h3>
          <div class="bar-chart-horizontal">
            <div
              *ngFor="let dist of distribucionOrdenada.slice(0, 5); let i = index"
              class="chart-bar-item"
            >
              <div class="chart-label">
                <span class="rank">{{ i + 1 }}</span>
                <span class="name">{{ dist.userId }}</span>
                <span class="value">{{ dist.cuentasAsignadas }}</span>
              </div>
              <div class="chart-bar-bg">
                <div
                  class="chart-bar-fill"
                  [style.width.%]="calcularPorcentajeCuentas(dist.cuentasAsignadas)"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráfico de Distribución de Balance -->
        <div class="chart-card">
          <h3>Top 5 Agentes por Balance Total</h3>
          <div class="bar-chart-horizontal">
            <div
              *ngFor="let dist of top5PorBalance; let i = index"
              class="chart-bar-item"
            >
              <div class="chart-label">
                <span class="rank">{{ i + 1 }}</span>
                <span class="name">{{ dist.userId }}</span>
                <span class="value">{{ formatearMoneda(dist.balanceTotalCuentas) }}</span>
              </div>
              <div class="chart-bar-bg">
                <div
                  class="chart-bar-fill balance"
                  [style.width.%]="calcularPorcentajeBalance(dist.balanceTotalCuentas)"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Info de Última Simulación -->
    <div class="section" *ngIf="ultimaSimulacion && ultimaSimulacion.resultadoFinal">
      <h2>Última Simulación Completada</h2>

      <div class="simulacion-info">
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Hipótesis:</span>
            <span class="value">TOP {{ ultimaSimulacion.hipotesis }}</span>
          </div>
          <div class="info-item">
            <span class="label">Días Simulados:</span>
            <span class="value">{{ ultimaSimulacion.resultadoFinal.diasSimulados }}</span>
          </div>
          <div class="info-item">
            <span class="label">ROI Global:</span>
            <span class="value" [ngClass]="obtenerClaseROI(ultimaSimulacion.resultadoFinal.roiGlobal)">
              {{ formatearPorcentaje(ultimaSimulacion.resultadoFinal.roiGlobal) }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Ganancia Total:</span>
            <span class="value positivo">
              {{ formatearMoneda(ultimaSimulacion.resultadoFinal.gananciaTotal) }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Total Divorcios:</span>
            <span class="value">{{ ultimaSimulacion.resultadoFinal.totalDivorcios }}</span>
          </div>
          <div class="info-item">
            <span class="label">Cambios en TOP10:</span>
            <span class="value">{{ ultimaSimulacion.resultadoFinal.cambiosEnTop10 }}</span>
          </div>
          <div class="info-item">
            <span class="label">Tiempo de Ejecución:</span>
            <span class="value">{{ ultimaSimulacion.tiempoEjecucion }} seg</span>
          </div>
          <div class="info-item">
            <span class="label">ID:</span>
            <span class="value small">{{ ultimaSimulacion.simulacionId }}</span>
          </div>
        </div>

        <div class="acciones-simulacion">
          <button
            routerLink="/simulacion/{{ ultimaSimulacion.simulacionId }}"
            class="btn-secondary"
          >
            Ver Detalles Completos
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
