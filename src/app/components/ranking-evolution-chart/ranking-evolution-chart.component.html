<div class="chart-container">
  <div class="chart-header">
    <h3 class="chart-title">{{ getTituloVista() }}<span *ngIf="tipoVista !== 'general'"> - {{ mostrarSoloTop10 ? 'TOP 10' : 'Todos los Agentes' }}</span></h3>

    <div class="chart-filters" *ngIf="!cargando && !error && (todosLosDatos.length > 0 || tipoVista === 'general')">
      <div class="filter-section">
        <span class="filter-label">Tipo de Vista:</span>
        <div class="filter-group">
          <button
            class="filter-button"
            [class.active]="tipoVista === 'hipotesis'"
            (click)="cambiarTipoVista('hipotesis')"
            title="Muestra el ROI acumulado al final de cada periodo de hipotesis (cada {{ hipotesis }} dias)">
            Por Hipotesis ({{ hipotesis }} dias)
          </button>
          <button
            class="filter-button"
            [class.active]="tipoVista === 'periodo'"
            (click)="cambiarTipoVista('periodo')"
            title="Muestra la evolucion del ROI desde el inicio (0%) hasta el final de cada periodo">
            Desde Inicio (0%)
          </button>
          <button
            class="filter-button"
            [class.active]="tipoVista === 'general'"
            (click)="cambiarTipoVista('general')"
            title="Muestra el ROI general de todos los agentes (suma de positivos y negativos)">
            ROI General
          </button>
        </div>
      </div>

      <div class="filter-section" *ngIf="tipoVista === 'periodo'">
        <span class="filter-label">Rango de Datos:</span>
        <div class="filter-group">
          <button
            class="filter-button"
            [class.active]="!usarFiltroFechas"
            (click)="toggleFiltroFechas(false)"
            title="Muestra todos los datos disponibles de la simulacion">
            Todos los Datos
          </button>
          <button
            class="filter-button"
            [class.active]="usarFiltroFechas"
            (click)="toggleFiltroFechas(true)"
            title="Filtra los datos solo al rango de fechas especificado"
            [disabled]="!fechaInicio || !fechaFin">
            Solo Rango Especificado
          </button>
        </div>
      </div>

      <div class="filter-section" *ngIf="tipoVista !== 'general'">
        <span class="filter-label">Agentes a Mostrar:</span>
        <div class="filter-group">
          <button
            class="filter-button"
            [class.active]="mostrarSoloTop10"
            (click)="toggleTop10()"
            title="Muestra solo los 10 mejores agentes por ROI">
            {{ mostrarSoloTop10 ? 'Solo TOP 10' : 'Todos los Agentes' }}
          </button>
          <button
            class="filter-button"
            [class.active]="mostrarExpulsados"
            (click)="toggleExpulsados()"
            title="Incluir o excluir agentes que fueron expulsados del ranking">
            {{ mostrarExpulsados ? 'Con Expulsados' : 'Sin Expulsados' }}
          </button>
        </div>
      </div>

      <span class="agents-count" *ngIf="tipoVista !== 'general'" title="Cantidad de agentes visibles en el grafico">
        Mostrando: {{ lineChartData.datasets.length }} / {{ todosLosDatos.length }} agentes
      </span>
    </div>
  </div>

  <div *ngIf="cargando" class="loading">
    <div class="spinner"></div>
    <p>Cargando grafico...</p>
  </div>

  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
    <button (click)="cargarDatos()" class="retry-button">Reintentar</button>
  </div>

  <div *ngIf="!cargando && !error" class="chart-wrapper">
    <div class="chart-info" *ngIf="lineChartData.datasets.length > 0 && tipoVista !== 'general'">
      <div class="info-item">
        <span class="info-icon" style="background: #3498db;"></span>
        <span class="info-text">Lineas mas gruesas = TOP 5 agentes</span>
      </div>
      <div class="info-item">
        <span class="info-icon" style="background: #e74c3c;"></span>
        <span class="info-text">Rojo = Agentes expulsados</span>
      </div>
      <div class="info-item">
        <span class="info-icon" style="background: #95a5a6;"></span>
        <span class="info-text">Gris = Resto de agentes</span>
      </div>
      <div class="info-item" *ngIf="tipoVista === 'hipotesis'">
        <span class="info-text" style="font-style: italic;">Pase el mouse sobre un punto para ver el TOP 10 de ese periodo</span>
      </div>
      <div class="info-item">
        <button (click)="resetZoom()" class="reset-zoom-button" title="Resetear zoom del grafico">
          Resetear Zoom
        </button>
      </div>
    </div>
    <div class="chart-info" *ngIf="lineChartData.datasets.length > 0 && tipoVista === 'general'">
      <div class="info-item">
        <span class="info-icon" style="background: #00B894;"></span>
        <span class="info-text">Verde = ROI General Acumulado (suma de ROIs positivos)</span>
      </div>
      <div class="info-item">
        <span class="info-icon" style="background: #e74c3c;"></span>
        <span class="info-text">Rojo = ROI General Ca√≠da (suma de ROIs negativos)</span>
      </div>
      <div class="info-item">
        <span class="info-icon" style="background: #3498db;"></span>
        <span class="info-text">Azul = ROI Neto (suma total: positivos + negativos)</span>
      </div>
      <div class="info-item">
        <span class="info-text" style="font-style: italic;">Pase el mouse sobre un punto para ver el TOP 10 de ese dia</span>
      </div>
      <div class="info-item">
        <button (click)="resetZoom()" class="reset-zoom-button" title="Resetear zoom del grafico">
          Resetear Zoom
        </button>
      </div>
    </div>
    <canvas
      baseChart
      [data]="lineChartData"
      [options]="lineChartOptions"
      [type]="lineChartType">
    </canvas>
  </div>

  <div *ngIf="!cargando && !error && lineChartData.datasets.length === 0" class="no-data">
    <p>No hay datos disponibles para mostrar</p>
    <p class="hint">Ejecute una simulacion con hipotesis {{ hipotesis }} para ver el grafico</p>
  </div>
</div>
